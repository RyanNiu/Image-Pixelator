# Next.js 项目从 Vercel 迁移至 Cloudflare Workers 最佳实践总结

本文档总结了从 Vercel 迁移 Next.js 项目到 Cloudflare Workers 的关键经验与教训，旨在为后续项目迁移提供标准化指导。

## 核心架构选择

### 1. 适配器选择：拥抱 OpenNext
*   **弃用**: `@cloudflare/next-on-pages`（已过时，对 Next.js 新特性支持有限）。
*   **推荐**: **`@opennextjs/cloudflare`**。
    *   **优势**: 支持 ISR（增量静态再生）、图片优化、App Router 完整特性，且自动处理 Edge/Node.js 运行时分割。
    *   **安装**: `npm install -D @opennextjs/cloudflare wrangler`

### 2. 部署模式：Workers vs Pages
*   虽然 Cloudflare Pages 很流行，但在使用 OpenNext 时，**Cloudflare Workers** 模式往往更灵活，特别是结合 `wrangler deploy` 和 `Assets`（静态资源）功能时。
*   OpenNext 的构建输出结构更适合作为 Worker 部署（`.open-next/worker.js` + `.open-next/assets`）。

## 关键配置与避坑指南

### 1. 运行时配置 (Runtime)
*   **不要手动锁死 Edge Runtime**：在 Vercel 或旧版适配器中，我们常在 `layout.tsx` 中写 `export const runtime = 'edge'`。
*   **OpenNext 能够自动处理**：OpenNext 会自动识别并将代码拆分到合适的运行时。**移除**手动声明的 `runtime = 'edge'`，否则会导致依赖 Node.js API 的库（如 `next-intl`, `async_hooks`）报错。

### 2. 依赖管理
*   **Peer Dependency 冲突**：Cloudflare 的环境与 Vercel 不同，`npm install` 经常遇到严格的 peer dependency 问题。
*   **解决方案**: 创建 `.npmrc` 文件并写入 `legacy-peer-deps=true`。这是最稳妥的解决方式。
*   **Wrangler**: 务必在 `devDependencies` 中显式安装最新版的 `wrangler`，不要依赖环境自带的版本。

### 3. `wrangler.toml` 配置要点
*   **Worker 名称一致性**: `name` 字段必须与 `package.json` 中的 `name` 保持一致，或者是你在 Dashboard 上创建的名称。
*   **入口文件**: 指向 `.open-next/worker.js`。
*   **静态资源 (Assets)**: 指向 `.open-next/assets`。
*   **Self-reference Binding (先有鸡还是先有蛋问题)**:
    *   OpenNext 默认会生成一个引用自身的 Service Binding (`WORKER_SELF_REFERENCE`) 用于内部请求（如 ISR 刷新）。
    *   **首次部署痛点**: 如果 Worker 还没创建，部署会失败，因为无法绑定到一个不存在的 Worker。
    *   **解决方法**:
        1.  先在 Cloudflare Dashboard 手动创建一个同名的空 Worker。
        2.  或者首次部署时使用 `--no-bundle` 先占位。
        3.  确保 `wrangler.toml` 中的 `name` 与 `services` 中的 `service` 名称完全一致。

### 4. 构建脚本
*   标准构建命令：
    ```json
    "pages:build": "npx opennextjs-cloudflare build"
    ```
*   Cloudflare 构建配置：
    *   Build command: `npm run pages:build`
    *   Deploy command: `npx wrangler deploy` (如果是 Workers 模式)

## 标准化迁移流程清单

1.  **清理环境**: 移除 `vercel.json`，清理 `next.config.mjs` 中 Vercel 特有的配置。
2.  **更换依赖**: 卸载 `@cloudflare/next-on-pages`，安装 `@opennextjs/cloudflare` 和 `wrangler`。
3.  **配置 npm**: 添加 `.npmrc` (`legacy-peer-deps=true`)。
4.  **修正代码**: 删除所有 `export const runtime = 'edge'`。
5.  **配置 Wrangler**: 创建 `wrangler.toml`，配置 Assets 和 Bindings。
6.  **预创建资源**:
    *   在 Cloudflare Dashboard 创建同名 Worker。
    *   创建 R2 Bucket（用于缓存）。
7.  **部署验证**: 运行部署并测试 ISR 和动态路由。

---
*Generated by Antigravity based on glitch-text migration (2026-01-07)*
