<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Pixelator Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        canvas { border: 1px solid #ccc; margin: 10px; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Image Pixelator - Core Function Test</h1>
    
    <div class="test-section">
        <h2>1. Image Upload Test</h2>
        <input type="file" id="testImageInput" accept="image/*">
        <p>Status: <span id="uploadStatus">Ready</span></p>
    </div>

    <div class="test-section">
        <h2>2. Pixelation Test</h2>
        <div>
            <label>Pixel Size: <input type="range" id="testPixelSize" min="1" max="50" value="8"></label>
            <span id="pixelSizeDisplay">8px</span>
        </div>
        <div>
            <label>Color Mode: 
                <select id="testColorMode">
                    <option value="original">Original</option>
                    <option value="retro">Retro 8-bit</option>
                    <option value="grayscale">Grayscale</option>
                </select>
            </label>
        </div>
        <button onclick="testPixelation()">Apply Pixelation</button>
    </div>

    <div class="test-section">
        <h2>3. Preview</h2>
        <div>
            <h3>Original</h3>
            <canvas id="testOriginalCanvas" width="300" height="300"></canvas>
        </div>
        <div>
            <h3>Pixelated</h3>
            <canvas id="testPixelatedCanvas" width="300" height="300"></canvas>
        </div>
    </div>

    <div class="test-section">
        <h2>4. Download Test</h2>
        <button onclick="testDownload('png')">Download PNG</button>
        <button onclick="testDownload('jpg')">Download JPG</button>
        <button onclick="testDownload('webp')">Download WebP</button>
    </div>

    <script type="module">
        import { ImagePixelator } from './src/utils/pixelator.js';
        
        const pixelator = new ImagePixelator();
        let currentImage = null;
        
        // Make functions global for onclick handlers
        window.testPixelation = function() {
            if (!currentImage) {
                alert('Please upload an image first');
                return;
            }
            
            const options = {
                pixelSize: parseInt(document.getElementById('testPixelSize').value),
                colorMode: document.getElementById('testColorMode').value,
                edgeMode: 'hard'
            };
            
            pixelator.pixelate(options);
            console.log('Pixelation applied with options:', options);
        };
        
        window.testDownload = function(format) {
            if (!currentImage) {
                alert('Please upload and process an image first');
                return;
            }
            
            pixelator.download(format, 0.9);
            console.log('Download initiated for format:', format);
        };
        
        // Setup event listeners
        document.getElementById('testImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                document.getElementById('uploadStatus').textContent = 'Loading...';
                
                // Override canvas elements for test
                pixelator.originalCanvas = document.getElementById('testOriginalCanvas');
                pixelator.pixelatedCanvas = document.getElementById('testPixelatedCanvas');
                
                currentImage = await pixelator.loadImage(file);
                document.getElementById('uploadStatus').textContent = `Loaded: ${file.name} (${currentImage.width}x${currentImage.height})`;
                
                // Apply initial pixelation
                testPixelation();
                
            } catch (error) {
                document.getElementById('uploadStatus').textContent = `Error: ${error.message}`;
                console.error('Load error:', error);
            }
        });
        
        document.getElementById('testPixelSize').addEventListener('input', (e) => {
            document.getElementById('pixelSizeDisplay').textContent = e.target.value + 'px';
        });
        
        console.log('Test page loaded successfully');
    </script>
</body>
</html>